<script>
  const PASSWORD = "coffee 007";
  const LOG_URL = "https://raw.githubusercontent.com/moullakill/SPY-FILES/main/machine_log.txt";
  let imagesData = []; // Pour stocker les images chargées et permettre le filtrage/inversion

  function verifyPassword() {
    const input = document.getElementById("password").value.trim();
    if (input === PASSWORD) {
      document.getElementById("auth").style.display = "none";
      document.getElementById("gallery-section").style.display = "flex";
      loadImages();
    } else {
      document.getElementById("error").style.display = "block";
    }
  }

  async function loadImages() {
    try {
      const response = await fetch(LOG_URL);
      if (!response.ok) {
        console.error(`Erreur de chargement du fichier: ${response.status} ${response.statusText}`);
        document.getElementById("gallery").innerHTML = "<p style='color: red;'>Erreur lors du chargement des données. Veuillez vérifier le fichier log.</p>";
        return;
      }
      const text = await response.text();
      let lines = text.split('\n').filter(line => line.includes(':'));
      lines = lines.reverse(); // Pour les plus récentes en premier

      const gallery = document.getElementById("gallery");
      gallery.innerHTML = ""; // Vide la galerie au début du chargement
      imagesData = []; // Réinitialise les données des images pour le nouveau chargement

      // Parcours chaque ligne et ajoute l'image dès qu'elle est prête
      for (const line of lines) { // Utilisation de for...of pour permettre await si nécessaire, mais forEach est aussi OK ici
        const [uid, base64] = line.split(':');
        const cleanBase64 = base64.trim();
        const mime = detectMime(cleanBase64);

        if (mime) {
          const img = document.createElement("img");
          img.src = `data:${mime};base64,${cleanBase64}`;
          img.alt = uid;
          img.setAttribute("data-title", uid);
          
          // Récupère la taille de l'image une fois chargée
          img.onload = function() {
            const width = img.naturalWidth;
            const height = img.naturalHeight;
            const sizeStr = width + "x" + height;
            img.setAttribute("data-size", sizeStr);
          }
          img.addEventListener('click', () => openModal(img.src, img.alt));
          
          // C'est ici que l'image est ajoutée AU FUR ET À MESURE
          gallery.appendChild(img);
          imagesData.push(img); // Ajoute à la liste pour le filtrage/inversion
        }
      }
    } catch (e) {
      console.error("Erreur de chargement ou de traitement des images : ", e);
      document.getElementById("gallery").innerHTML = "<p style='color: red;'>Une erreur inattendue est survenue lors du chargement des images.</p>";
    }
  }

  function detectMime(b64) {
    if (b64.startsWith("/9j/")) return "image/jpeg";
    if (b64.startsWith("iVBOR")) return "image/png";
    if (b64.startsWith("R0lGOD")) return "image/gif";
    if (b64.startsWith("UklGR")) return "image/webp";
    return null;
  }

  function openModal(src, alt) {
    const modal = document.getElementById("image-modal");
    const modalImg = document.getElementById("modal-img");
    const modalCaption = document.getElementById("modal-caption");
    modalImg.src = src;
    modalImg.alt = alt;
    modalCaption.innerText = alt;
    modal.style.display = "flex";
  }

  function closeModal() {
    document.getElementById("image-modal").style.display = "none";
  }

  document.getElementById("image-modal").addEventListener("click", function(e) {
    if (e.target.id === "image-modal") {
      closeModal();
    }
  });

  function filterGallery() {
    const query = document.getElementById("searchInput").value.toLowerCase();
    // Utilise imagesData pour le filtrage, car c'est la source de toutes les images
    for (let img of imagesData) { 
      const title = img.getAttribute("data-title").toLowerCase();
      const size = img.getAttribute("data-size") ? img.getAttribute("data-size").toLowerCase() : "";
      if (title.includes(query) || size.includes(query)) {
        img.style.display = "";
      } else {
        img.style.display = "none";
      }
    }
  }

  function reverseOrder() {
    const gallery = document.getElementById("gallery");
    // Inverse imagesData directement
    imagesData.reverse(); 
    gallery.innerHTML = ""; // Vide la galerie
    // Ré-ajoute les images dans le nouvel ordre
    imagesData.forEach(img => gallery.appendChild(img));
  }
</script>
